<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Transferencia de ficheros con PeerJS (fallback)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:Arial,sans-serif;margin:0;padding:1rem;background:#f5f5f5}
  .card{background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:600px;margin:auto}
  h1{font-size:1.6rem;margin:0 0 .5rem}
  #statusBar{margin-top:1rem;height:1.2rem;background:#e0e0e0;border-radius:4px;overflow:hidden}
  #statusBar div{height:100%;width:0;background:#4caf50;transition:width .3s}
  #link{word-break:break-all;color:#0066cc}
  button{background:#0066ff;color:#fff;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer;margin-right:.5rem}
  button:disabled{background:#999;cursor:not-allowed}
  #msg{margin-top:.8rem;padding:.5rem;background:#fffae6;border-left:4px solid #ffeb3b}
  #langToggle{position:fixed;top:1rem;right:1rem;background:#eee;color:#333;padding:.3rem .6rem;border-radius:4px;cursor:pointer}
</style>
</head>
<body>
<div id="langToggle">ğŸ‡ªğŸ‡¸ / ğŸ‡¬ğŸ‡§</div>

<div class="card">
  <h1 id="title">ğŸ”— Compartir archivo / Share file</h1>

  <!-- SEND SIDE -->
  <div id="sender">
    <input type="file" id="fileInput">
    <p id="shareLink" style="display:none;">
      <span id="shareText">Copia y pega esta URL en el navegador del receptor</span>:
      <br>
      <span id="link"></span>
      <button id="copyBtn">ğŸ“‹ Copy / Copiar</button>
    </p>
    <div id="msg"></div>
  </div>

  <!-- RECEIVE SIDE -->
  <div id="receiver" style="display:none;">
    <p><b id="recvLabel">Receiving:</b> <span id="recvName"></span></p>
    <a id="downloadBtn" style="display:none;" download>â¬‡ï¸ Download / Descargar</a>
    <div id="msg"></div>
  </div>

  <!-- PROGRESS -->
  <div id="statusBar"><div></div></div>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
(() => {
  /* --------------------------------------------------------------
   * 1ï¸âƒ£  TEXTS (ES / EN) â€“ same object as before
   * ------------------------------------------------------------ */
  const LANG = {
    es:{title:'ğŸ”— Compartir archivo',shareText:'Copia y pega esta URL en el navegador del receptor',copy:'ğŸ“‹ Copiar',copied:'âœ… Copiado al portapapeles',waiting:'â³ Esperando conexiÃ³nâ€¦',connected:'âœ… ConexiÃ³n establecida',sending:'ğŸ“¤ Enviando archivoâ€¦',received:'ğŸ“¥ Archivo recibido',download:'â¬‡ï¸ Descargar',recv:'Recibiendo:',finished:'âœ… Transferencia completada',dontClose:'âš ï¸ No cierres la ventana hasta que la descarga termine',error:'â— Error: '},
    en:{title:'ğŸ”— Share file',shareText:'Copy & paste this URL into the receiverâ€™s browser',copy:'ğŸ“‹ Copy',copied:'âœ… Copied to clipboard',waiting:'â³ Waiting for connectionâ€¦',connected:'âœ… Connected',sending:'ğŸ“¤ Sending fileâ€¦',received:'ğŸ“¥ File received',download:'â¬‡ï¸ Download',recv:'Receiving:',finished:'âœ… Transfer complete',dontClose:'âš ï¸ Do not close the window until the download finishes',error:'â— Error: '}
  };
  let curLang = 'es';
  const t = () => LANG[curLang];

  /* --------------------------------------------------------------
   * 2ï¸âƒ£  UI helpers
   * ------------------------------------------------------------ */
  const ui = {
    title:        document.getElementById('title'),
    fileInput:    document.getElementById('fileInput'),
    shareLink:    document.getElementById('shareLink'),
    linkSpan:     document.getElementById('link'),
    copyBtn:      document.getElementById('copyBtn'),
    sender:       document.getElementById('sender'),
    receiver:     document.getElementById('receiver'),
    recvLabel:    document.getElementById('recvLabel'),
    recvName:     document.getElementById('recvName'),
    downloadBtn:  document.getElementById('downloadBtn'),
    statusBar:    document.getElementById('statusBar').firstElementChild,
    msgArea:      document.querySelectorAll('#msg'),
    langToggle:   document.getElementById('langToggle')
  };

  const setLang = (l)=>{curLang=l;ui.title.textContent=t().title;ui.shareLink.querySelector('#shareText').textContent=t().shareText;ui.copyBtn.textContent=t().copy;ui.recvLabel.textContent=t().recv;ui.downloadBtn.textContent=t().download;ui.msgArea.forEach(m=>m.textContent='');};
  setLang(curLang);
  ui.langToggle.onclick=()=>setLang(curLang==='es'?'en':'es');

  const setMsg = m=>ui.msgArea.forEach(x=>x.textContent=m);
  const updateProgress = r=>{const p=Math.min(100,Math.round(r*100));ui.statusBar.style.width=p+'%';if(p===100)ui.statusBar.style.background='#2196F3';};

  /* --------------------------------------------------------------
   * 3ï¸âƒ£  PEERJS FALLBACK LOGIC
   * ------------------------------------------------------------ */
  const servers = [
    {host:'0.peerjs.com', secure:true, port:443},
    {host:'peerjs.com',    secure:true, port:443},
    {host:'peerjs-server.herokuapp.com', secure:true, port:443},
    {host:'peerjscloud.com', secure:true, port:443}
  ];
  let peer = null;
  let serverIdx = 0;
  const initPeer = () => {
    if (serverIdx>=servers.length) {
      setMsg(t().error+'No se pudo conectar a ningÃºn servidor de seÃ±alizaciÃ³n.');
      return;
    }
    const cfg = servers[serverIdx];
    try {
      peer = new Peer(null, cfg);
      peer.on('open', id=>{console.log('Peer opened with id',id,'using',cfg.host);});
      peer.on('error', err=>{
        console.warn('Error on',cfg.host,err);
        // intento con el siguiente servidor
        serverIdx++;
        initPeer();
      });
    } catch(e){
      console.error('ExcepciÃ³n al crear Peer con',cfg.host,e);
      serverIdx++;
      initPeer();
    }
  };
  initPeer();   // <-- arranca la cadena de intentos

  /* --------------------------------------------------------------
   * 4ï¸âƒ£  SENDER (idem que antes)
   * ------------------------------------------------------------ */
  const CHUNK_SIZE = 64*1024;
  let fileMeta=null;
  let downloadFinished=false;

  ui.fileInput.addEventListener('change',()=>{
    const f=ui.fileInput.files[0];
    if(!f) return;
    fileMeta={name:f.name,size:f.size,type:f.type};
    const url=`${location.origin}${location.pathname}?peer=${peer.id}`;
    ui.linkSpan.textContent=url;
    ui.shareLink.style.display='block';
    setMsg(t().waiting);
  });

  ui.copyBtn.addEventListener('click',async()=>{
    try{
      await navigator.clipboard.writeText(ui.linkSpan.textContent);
      ui.copyBtn.textContent=t().copied;
      setTimeout(()=>ui.copyBtn.textContent=t().copy,2000);
    }catch(e){console.error('Clipboard error',e);}
  });

  peer && peer.on('connection',conn=>{
    setMsg(t().connected);
    conn.on('open',()=>sendFile(conn,ui.fileInput.files[0]));
    conn.on('error',e=>{console.error('Conn error',e);setMsg(t().error+e);});
  });

  async function sendFile(conn,file){
    setMsg(t().sending);
    conn.send({type:'meta',data:fileMeta});
    updateProgress(0);
    const reader=file.stream().getReader();
    let sent=0;
    while(true){
      const {done,value}=await reader.read();
      if(done)break;
      conn.send({type:'chunk',data:value.buffer});   // ArrayBuffer transferrable
      sent+=value.byteLength;
      updateProgress(sent/fileMeta.size);
    }
    conn.send({type:'end'});
    setMsg(t().finished);
  }

  /* --------------------------------------------------------------
   * 5ï¸âƒ£  RECEIVER (idem que antes)
   * ------------------------------------------------------------ */
  const urlParams=new URLSearchParams(location.search);
  const remoteId=urlParams.get('peer');
  if(remoteId){
    ui.sender.style.display='none';
    ui.receiver.style.display='block';
    setMsg(t().waiting);
    const conn=peer.connect(remoteId);
    conn.on('open',()=>{setMsg(t().connected);});
    conn.on('data',handleIncoming);
    conn.on('error',e=>{console.error('Conn error',e);setMsg(t().error+e);});
  }

  const chunks=[];
  function handleIncoming(msg){
    if(msg.type==='meta'){
      fileMeta=msg.data;
      ui.recvName.textContent=fileMeta.name;
      setMsg(t().received);
      updateProgress(0);
    }else if(msg.type==='chunk'){
      chunks.push(new Uint8Array(msg.data));
      const received=chunks.reduce((s,c)=>s+c.byteLength,0);
      updateProgress(received/fileMeta.size);
    }else if(msg.type==='end'){
      const blob=new Blob(chunks,{type:fileMeta.type});
      const dl=URL.createObjectURL(blob);
      ui.downloadBtn.href=dl;
      ui.downloadBtn.download=fileMeta.name;
      ui.downloadBtn.style.display='inline-block';
      updateProgress(1);
      setMsg(t().finished);
      ui.downloadBtn.onclick=()=>{downloadFinished=true;setTimeout(()=>URL.revokeObjectURL(dl),30000);};
    }
  }

  /* --------------------------------------------------------------
   * 6ï¸âƒ£  PREVENT CLOSE UNTIL DOWNLOAD FINISHED
   * ------------------------------------------------------------ */
  const preventClose=e=>{
    if(!downloadFinished){
      e.preventDefault();
      e.returnValue=t().dontClose;
      return t().dontClose;
    }
  };
  window.addEventListener('beforeunload',preventClose);
  window.addEventListener('error',e=>{console.error('Global error',e.error);setMsg(t().error+e.message);});
})();
</script>
</body>
</html>
