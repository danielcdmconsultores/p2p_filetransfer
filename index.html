<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Transferencia de ficheros con PeerJS / File sharing with PeerJS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:Arial,sans-serif;margin:0;padding:1rem;background:#f5f5f5}
  .card{background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:600px;margin:auto}
  h1{font-size:1.6rem;margin:0 0 .5rem}
  #statusBar{margin-top:1rem;height:1.2rem;background:#e0e0e0;border-radius:4px;overflow:hidden}
  #statusBar div{height:100%;width:0;background:#4caf50;transition:width .3s}
  #link{word-break:break-all;color:#0066cc}
  button{background:#0066ff;color:#fff;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer;margin-right:.5rem}
  button:disabled{background:#999;cursor:not-allowed}
  #msg{margin-top:.8rem;padding:.5rem;background:#fffae6;border-left:4px solid #ffeb3b}
  #langToggle{position:fixed;top:1rem;right:1rem;background:#eee;color:#333;padding:.3rem .6rem;border-radius:4px;cursor:pointer}
</style>
</head>
<body>
<div id="langToggle">ğŸ‡ªğŸ‡¸ / ğŸ‡¬ğŸ‡§</div>

<div class="card">
  <h1 id="title">ğŸ”— Compartir archivo / Share file</h1>

  <!-- ---------- SENDER ---------- -->
  <div id="sender">
    <input type="file" id="fileInput">
    <p id="shareLink" style="display:none;">
      <span id="shareText">Copia y pega esta URL en el navegador del receptor</span>:
      <br>
      <span id="link"></span>
      <button id="copyBtn">ğŸ“‹ Copy / Copiar</button>
    </p>
    <div id="msg"></div>
  </div>

  <!-- ---------- RECEIVER ---------- -->
  <div id="receiver" style="display:none;">
    <p><b id="recvLabel">Receiving:</b> <span id="recvName"></span></p>
    <a id="downloadBtn" style="display:none;" download>â¬‡ï¸ Download / Descargar</a>
    <div id="msg"></div>
  </div>

  <!-- ---------- PROGRESS BAR ---------- -->
  <div id="statusBar"><div></div></div>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
(() => {
  /* ==============================================================
   *  1ï¸âƒ£  SETTINGS & GLOBAL STATE
   * ============================================================== */
  const LANG = {                 // text in both languages
    es: {
      title:       'ğŸ”— Compartir archivo',
      shareText:   'Copia y pega esta URL en el navegador del receptor',
      copy:        'ğŸ“‹ Copiar',
      copied:      'âœ… Copiado al portapapeles',
      waiting:     'â³ Esperando conexiÃ³nâ€¦',
      connected:   'âœ… ConexiÃ³n establecida',
      sending:     'ğŸ“¤ Enviando archivoâ€¦',
      received:    'ğŸ“¥ Archivo recibido',
      download:    'â¬‡ï¸ Descargar',
      recv:        'Recibiendo:',
      finished:    'âœ… Transferencia completada',
      dontClose:   'âš ï¸ No cierres la ventana hasta que la descarga termine',
      error:       'â— Error: '
    },
    en: {
      title:       'ğŸ”— Share file',
      shareText:   'Copy & paste this URL into the receiverâ€™s browser',
      copy:        'ğŸ“‹ Copy',
      copied:      'âœ… Copied to clipboard',
      waiting:     'â³ Waiting for connectionâ€¦',
      connected:   'âœ… Connected',
      sending:     'ğŸ“¤ Sending fileâ€¦',
      received:    'ğŸ“¥ File received',
      download:    'â¬‡ï¸ Download',
      recv:        'Receiving:',
      finished:    'âœ… Transfer complete',
      dontClose:   'âš ï¸ Do not close the window until the download finishes',
      error:       'â— Error: '
    }
  };
  let curLang = 'es';                     // default language
  const txt = () => LANG[curLang];        // helper to read current language

  const peer = new Peer(null, {           // use public PeerJS server (TLS)
    host: '0.peerjs.com',
    secure: true,
    port: 443
  });

  const ui = {
    title:        document.getElementById('title'),
    fileInput:    document.getElementById('fileInput'),
    shareLink:    document.getElementById('shareLink'),
    linkSpan:     document.getElementById('link'),
    copyBtn:      document.getElementById('copyBtn'),
    sender:       document.getElementById('sender'),
    receiver:     document.getElementById('receiver'),
    recvLabel:    document.getElementById('recvLabel'),
    recvName:     document.getElementById('recvName'),
    downloadBtn:  document.getElementById('downloadBtn'),
    statusBar:    document.getElementById('statusBar').firstElementChild,
    msgArea:      document.querySelectorAll('#msg'),
    langToggle:   document.getElementById('langToggle')
  };

  const CHUNK_SIZE = 64 * 1024;           // 64â€¯KB chunks (good for dataâ€‘channels)

  let fileMeta = null;                   // {name,size,type}
  let chunks   = [];                     // received Uint8Array's
  let downloadFinished = false;          // used for beforeunload warning

  /* ==============================================================
   *  2ï¸âƒ£  UI HELPERS (language switch, status messages, progress)
   * ============================================================== */
  const setLang = (l) => {
    curLang = l;
    ui.title.textContent      = txt().title;
    ui.shareLink.querySelector('#shareText').textContent = txt().shareText;
    ui.copyBtn.textContent    = txt().copy;
    ui.recvLabel.textContent  = txt().recv;
    ui.downloadBtn.textContent = txt().download;
    // refresh current message (if any)
    ui.msgArea.forEach(m => m.textContent = '');
  };
  setLang(curLang);                     // initialise texts

  ui.langToggle.addEventListener('click', () => {
    setLang(curLang === 'es' ? 'en' : 'es');
  });

  const setMsg = (msg) => {
    ui.msgArea.forEach(m => m.textContent = msg);
  };

  const updateProgress = (ratio) => {
    const pct = Math.min(100, Math.round(ratio * 100));
    ui.statusBar.style.width = pct + '%';
    if (pct === 100) ui.statusBar.style.background = '#2196F3';
  };

  const preventClose = (e) => {
    if (!downloadFinished) {
      e.preventDefault();
      e.returnValue = txt().dontClose;
      return txt().dontClose;
    }
  };
  window.addEventListener('beforeunload', preventClose);

  /* ==============================================================
   *  3ï¸âƒ£  SENDER LOGIC
   * ============================================================== */
  peer.on('open', id => {
    console.log('Peer opened with id:', id);
    // nothing else to do until a file is selected
  });

  ui.fileInput.addEventListener('change', () => {
    const file = ui.fileInput.files[0];
    if (!file) return;

    fileMeta = {name: file.name, size: file.size, type: file.type};

    const url = `${location.origin}${location.pathname}?peer=${peer.id}`;
    ui.linkSpan.textContent = url;
    ui.shareLink.style.display = 'block';
    setMsg(txt().waiting);
  });

  // Copyâ€‘toâ€‘clipboard button
  ui.copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(ui.linkSpan.textContent);
      ui.copyBtn.textContent = txt().copied;
      setTimeout(() => ui.copyBtn.textContent = txt().copy, 2000);
    } catch (err) {
      console.error('Clipboard error', err);
    }
  });

  // When a receiver connects we start sending
  peer.on('connection', conn => {
    setMsg(txt().connected);
    console.log('Incoming connection from', conn.peer);
    conn.on('open', () => sendFile(conn, ui.fileInput.files[0]));
    conn.on('error', err => {
      console.error('Connection error', err);
      setMsg(txt().error + err);
    });
  });

  async function sendFile(conn, file) {
    setMsg(txt().sending);
    // 1ï¸âƒ£ Send meta first
    conn.send({type: 'meta', data: fileMeta});
    updateProgress(0);

    // 2ï¸âƒ£ Stream file in chunks
    const reader = file.stream().getReader();
    let sent = 0;

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      // value is Uint8Array â†’ send its underlying ArrayBuffer (transferable)
      conn.send({type: 'chunk', data: value.buffer});
      sent += value.byteLength;
      updateProgress(sent / fileMeta.size);
    }

    // 3ï¸âƒ£ End marker
    conn.send({type: 'end'});
    setMsg(txt().finished);
    console.log('File sent');
  }

  /* ==============================================================
   *  4ï¸âƒ£  RECEIVER LOGIC
   * ============================================================== */
  const urlParams = new URLSearchParams(location.search);
  const remoteId = urlParams.get('peer');

  if (remoteId) {
    // Hide sender UI, show receiver UI
    ui.sender.style.display = 'none';
    ui.receiver.style.display = 'block';
    setMsg(txt().waiting);

    const conn = peer.connect(remoteId);
    conn.on('open', () => {
      setMsg(txt().connected);
      console.log('Connected to peer', remoteId);
    });
    conn.on('data', handleIncoming);
    conn.on('error', err => {
      console.error('Connection error', err);
      setMsg(txt().error + err);
    });
  }

  function handleIncoming(msg) {
    if (msg.type === 'meta') {
      fileMeta = msg.data;
      ui.recvName.textContent = fileMeta.name;
      setMsg(txt().received);
      updateProgress(0);
    } else if (msg.type === 'chunk') {
      chunks.push(new Uint8Array(msg.data));
      const received = chunks.reduce((s, c) => s + c.byteLength, 0);
      updateProgress(received / fileMeta.size);
    } else if (msg.type === 'end') {
      const blob = new Blob(chunks, {type: fileMeta.type});
      const dlUrl = URL.createObjectURL(blob);
      ui.downloadBtn.href = dlUrl;
      ui.downloadBtn.download = fileMeta.name;
      ui.downloadBtn.style.display = 'inline-block';
      updateProgress(1);
      setMsg(txt().finished);
      // Once the user clicks the download button we consider the job done
      ui.downloadBtn.addEventListener('click', () => {
        downloadFinished = true;          // allow window to be closed
        setTimeout(() => URL.revokeObjectURL(dlUrl), 30_000);
      });
    }
  }

  /* ==============================================================
   *  5ï¸âƒ£  GLOBAL ERROR HANDLING
   * ============================================================== */
  window.addEventListener('error', e => {
    console.error('Global error', e.error);
    setMsg(txt().error + e.message);
  });
})();
</script>
</body>
</html>
