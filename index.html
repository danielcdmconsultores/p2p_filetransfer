<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>P2P File Share ¬∑ PeerJS (auto ready + STUN)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self' https://unpkg.com https://peerjs.com; script-src 'self' https://unpkg.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src https: wss:; img-src 'self' data:; base-uri 'none'; frame-ancestors 'none'">
<style>
:root{--bg:#0b1020;--card:#141a2a;--muted:#9fb0d0;--accent:#46c3ff;--ok:#38d39f;--warn:#ffcc00;--err:#ff6677}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
.wrap{max-width:960px;margin:auto;padding:16px}.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{margin:0 0 8px;font-size:1.35rem} h2{margin:14px 0 8px;font-size:1.05rem;color:var(--accent)}
.row{display:grid;gap:12px;grid-template-columns:1fr}@media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
label{display:block;font-size:.9rem;margin:.4rem 0 .2rem;color:var(--muted)}
input[type="text"],input[type="url"],input[type="number"],select{width:100%;padding:10px;border-radius:12px;border:1px solid #2a324a;background:#0f1424;color:#fff}
input[type="file"]{width:100%;padding:10px;border-radius:12px;border:1px dashed #2a324a;background:#0f1424}
button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#001019;font-weight:700}
button.ghost{background:transparent;border:1px solid #2a324a;color:#bcd}
button[disabled]{opacity:.55;cursor:not-allowed}
.muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;word-break:break-all}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1424;border:1px solid #2a324a;margin-right:6px;font-size:.8rem}
.progress{height:14px;background:#0f1424;border-radius:999px;overflow:hidden;border:1px solid #2a324a}.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#7ff);transition:width .15s}
.status{white-space:pre-wrap;background:#0f1424;border-radius:12px;padding:12px;min-height:110px;max-height:260px;overflow:auto;border:1px solid #2a324a}
.ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)} a{color:#7fd8ff}
.hint{font-size:.85rem;margin-top:6px}
</style>
<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js" integrity="sha384-Nc3z3lIbjo4iC7cLW6Z0pQPCf2Bzqkbk1bAH6QOqVgd1m8J1E6b8i2rU8cG3Fv0w" crossorigin="anonymous"></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>üì¶ P2P File Share (WebRTC + PeerJS)</h1>
  <p class="muted">Selecciona un fichero ‚Üí genera URL ‚Üí √°brela en el receptor. <strong>No cierres</strong> el emisor hasta 100% ‚úÖ.</p>

  <div class="row">
    <section>
      <h2>1) Se√±alizaci√≥n e ICE</h2>
      <div class="row">
        <div><label>Servidor PeerJS (vac√≠o = Cloud)</label><input id="host" type="text" placeholder="p.ej. peerjs.com o tu.domino.com"></div>
        <div><label>Secure</label><select id="secure"><option value="true" selected>true</option><option value="false">false</option></select></div>
        <div><label>Puerto</label><input id="port" type="number" placeholder="443"></div>
        <div><label>Path</label><input id="path" type="text" placeholder="/"></div>
      </div>
      <details><summary>TURN (opcional para NAT muy estricto)</summary>
        <label>TURN URL</label><input id="turnUrl" type="text" placeholder="turn:turn.example.com:3478">
        <label>TURN usuario</label><input id="turnUser" type="text" placeholder="usuario">
        <label>TURN contrase√±a</label><input id="turnPass" type="text" placeholder="contrase√±a">
      </details>
      <div style="margin-top:8px">
        <button id="btnInit">Inicializar Peer</button>
        <span class="pill">Peer ID: <span id="peerId" class="mono">‚Äî</span></span>
        <span class="pill">Servidor: <span id="srvInfo" class="mono">Cloud (auto)</span></span>
        <div class="hint muted">Estado: <span id="peerReady" class="warn">inicializando‚Ä¶</span></div>
      </div>
    </section>

    <section>
      <h2>2) Compartir / Recibir</h2>
      <label>Tu fichero</label>
      <input id="fileInput" type="file" />
      <div class="hint muted">Necesitas: <span id="needFile" class="warn">elegir archivo</span> + <span id="needPeer" class="warn">Peer listo</span></div>
      <div style="display:grid;gap:10px;grid-template-columns:1fr auto;margin-top:8px">
        <button id="btnShare" disabled>Generar URL de recepci√≥n</button>
        <button id="btnCopy" class="ghost" disabled>Copiar URL</button>
      </div>
      <label>URL para receptor</label>
      <input id="shareUrl" type="url" readonly>
      <div style="margin-top:6px">
        <span class="pill">Rol: <strong id="role">auto</strong></span>
        <span class="pill">Conectado a: <span id="remoteId" class="mono">‚Äî</span></span>
      </div>

      <h2>Progreso</h2>
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div style="display:grid;grid-template-columns:1fr auto">
        <div class="muted">Enviado/Recibido: <span id="progressTxt">0 / 0</span></div>
        <div class="muted" style="text-align:right">Estado: <span id="state">Idle</span></div>
      </div>

      <div id="downloadBox" style="display:none;margin-top:10px">
        <a id="downloadLink" download class="pill">Descargar fichero recibido</a>
      </div>
    </section>
  </div>

  <h2>Logs & Diagn√≥stico</h2>
  <div class="status" id="log"></div>
  <details style="margin-top:10px"><summary>‚ö†Ô∏è Consejos</summary>
    <ul>
      <li>Para mejor compatibilidad, sirve el archivo v√≠a <code>http://localhost</code> (p.ej., <code>python -m http.server 8000</code>). Algunos navegadores limitan WebRTC en <code>file://</code>.</li>
      <li>STUN p√∫blicos (Google/Twilio/Cloudflare) ya preconfigurados. Para NAT muy estricto, a√±ade TURN propio.</li>
    </ul>
  </details>
</div></div>

<script>
(() => {
  'use strict';
  const $ = id => document.getElementById(id);
  const log = (m,l='info')=>{const t=new Date().toLocaleTimeString();$('log').innerText+=`[${t}] ${m}\n`;$('log').scrollTop=$('log').scrollHeight;}
  const setState = s => $('state').innerText = s;
  const human = b => { if(!Number.isFinite(b)) return '0 B'; const u=['B','KB','MB','GB','TB'];let i=0,n=b;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(n<10?2:1)+' '+u[i]; }
  const setBar = (num,den)=>{const pct=den?Math.min(100,Math.round((num/den)*100)):0;$('bar').style.width=pct+'%';$('progressTxt').innerText=human(num)+' / '+human(den);}

  // Estado
  let peer=null, conn=null, isSender=false, selectedFile=null;
  let retryCount=0; const MAX_RETRIES=3;
  const CHUNK=64*1024;

  // STUN p√∫blicos
  const DEFAULT_STUN=[
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'stun:stun1.l.google.com:19302'},
    {urls:'stun:stun2.l.google.com:19302'},
    {urls:'stun:global.stun.twilio.com:3478?transport=udp'},
    {urls:'stun:stun.cloudflare.com:3478'}
  ];

  // UI enablement
  function refreshShareEnabled(){
    const ready = !!(peer && peer.open);
    $('needPeer').className = ready ? 'ok' : 'warn';
    $('needPeer').textContent = ready ? 'Peer listo' : 'Peer no listo';
    const hasFile = !!selectedFile;
    $('needFile').className = hasFile ? 'ok' : 'warn';
    $('needFile').textContent = hasFile ? 'archivo seleccionado' : 'elegir archivo';
    $('btnShare').disabled = !(ready && hasFile);
  }

  // Build opciones Peer
  function buildPeerOptions(){
    const host=$('host').value.trim();
    const secure=$('secure').value==='true';
    const port=$('port').value?parseInt($('port').value,10):(secure?443:80);
    const path=$('path').value.trim()||'/';
    const iceServers=[...DEFAULT_STUN];
    const turnUrl=$('turnUrl').value.trim();
    if(turnUrl){
      const t={urls:turnUrl};
      if($('turnUser').value) t.username=$('turnUser').value;
      if($('turnPass').value) t.credential=$('turnPass').value;
      iceServers.push(t);
    }
    const base={debug:2,config:{iceServers}};
    if(host) Object.assign(base,{host,port,path,secure});
    return base;
  }

  function initPeer(){
    if(peer && !peer.destroyed) try{peer.destroy();}catch{}
    const opts=buildPeerOptions();
    const usingCloud = !('host' in opts);
    $('srvInfo').innerText = usingCloud ? 'Cloud (auto)' : `${opts.secure?'wss':'ws'}://${opts.host}:${opts.port}${opts.path}`;
    log(`Inicializando PeerJS‚Ä¶ Servidor: ${$('srvInfo').innerText}`);
    peer=new Peer(opts);

    $('peerReady').textContent='abriendo‚Ä¶'; $('peerReady').className='warn'; refreshShareEnabled();

    peer.on('open',(id)=>{
      $('peerId').innerText=id;
      $('peerReady').textContent='listo'; $('peerReady').className='ok';
      log(`Peer abierto con ID ${id}.`);
      setState('Listo');
      refreshShareEnabled();
      if(fromId) connectTo(fromId);
    });

    peer.on('disconnected',()=>{
      log('Se perdi√≥ se√±alizaci√≥n. Reintentando‚Ä¶','warn');
      $('peerReady').textContent='reconectando‚Ä¶'; $('peerReady').className='warn';
      setState('Desconectado (reintentando‚Ä¶)');
      if(retryCount<MAX_RETRIES){retryCount++;try{peer.reconnect();}catch{}}
      else log('L√≠mite de reintentos alcanzado.','err');
      refreshShareEnabled();
    });

    peer.on('error',(err)=>{ log('Peer error: '+(err?.message||String(err)),'err'); setState('Error'); $('peerReady').textContent='error'; $('peerReady').className='err'; refreshShareEnabled(); });
    peer.on('close',()=>{ log('Peer cerrado.','warn'); setState('Cerrado'); $('peerReady').textContent='cerrado'; $('peerReady').className='warn'; refreshShareEnabled(); });

    peer.on('connection',(c)=>{
      log(`Conexi√≥n entrante de ${c.peer}`);
      conn=c; $('remoteId').innerText=c.peer; isSender=true;
      setupConn(c);
      if(selectedFile) startSend(); else log('Selecciona un fichero para empezar la transferencia.');
    });
  }

  // Si clicas "Generar URL" y el Peer a√∫n no est√° listo, esperamos a on('open') y continuamos.
  function ensurePeerReadyThen(action){
    if(peer && peer.open){ action(); return; }
    log('Esperando a que el Peer est√© listo‚Ä¶');
    if(!peer) initPeer();
    const onOpen=(id)=>{ try{peer.off('open', onOpen);}catch{} action(); };
    peer.on('open', onOpen);
  }

  function createShareUrl(){
    ensurePeerReadyThen(()=>{
      if(!selectedFile){ log('Selecciona un fichero primero.','warn'); return; }
      const u=new URL(location.href);
      u.searchParams.set('from', peer.id);
      const host=$('host').value.trim(); if(host) u.searchParams.set('host',host);
      const secure=$('secure').value; if(secure) u.searchParams.set('secure',secure);
      const port=$('port').value.trim(); if(port) u.searchParams.set('port',port);
      const path=$('path').value.trim(); if(path) u.searchParams.set('path',path);
      $('shareUrl').value=u.toString();
      $('btnCopy').disabled=false;
      setState('Esperando conexi√≥n del receptor‚Ä¶');
      log('URL generada. Comp√°rtela con el receptor. No cierres esta pesta√±a hasta finalizar ‚úÖ');
      alert('¬°URL lista! P√©gala en el navegador receptor. Mant√©n esta pesta√±a abierta hasta 100%.');
    });
  }

  function connectTo(remoteId){
    if(!peer){ log('Inicializando Peer para conectar‚Ä¶'); initPeer(); }
    isSender=false; $('role').innerText='Receptor'; $('remoteId').innerText=remoteId;
    log(`Conectando con ${remoteId}‚Ä¶`);
    conn=peer.connect(remoteId,{reliable:true,serialization:'binary'});
    setupConn(conn);
  }

  function setupConn(c){
    c.on('open',()=>{ log('DataChannel abierto.'); setState(isSender?'Listo para enviar':'Esperando datos‚Ä¶'); wireDiagnostics(c); });
    c.on('data', handleIncomingData);
    c.on('error', e=>{ log('Conn error: '+e.message,'err'); setState('Error'); });
    c.on('close',()=>{ log('Conexi√≥n cerrada.'); if(!isSender) finalizeReceive(); });
  }

  // Diagn√≥stico ICE
  let statsTimer=null;
  function wireDiagnostics(c){
    try{
      const pc=c._pc||c.peerConnection||c.provider?.connections?.[c.peer]?.[0]?._pc;
      if(!pc){ log('RTCPeerConnection no accesible para stats (ok).'); return; }
      log(`ICE state: ${pc.iceConnectionState} ¬∑ Conn state: ${pc.connectionState}`);
      pc.addEventListener('iceconnectionstatechange',()=>log(`ICE state ‚Üí ${pc.iceConnectionState}`));
      pc.addEventListener('connectionstatechange',()=>log(`PeerConn state ‚Üí ${pc.connectionState}`));
      if(statsTimer) clearInterval(statsTimer);
      statsTimer=setInterval(async()=>{
        try{
          const stats=await pc.getStats(); let selected=null,local={},remote={};
          stats.forEach(r=>{ if(r.type==='transport' && r.selectedCandidatePairId) selected=stats.get(r.selectedCandidatePairId); });
          if(!selected){ stats.forEach(r=>{ if(r.type==='candidate-pair'&&r.nominated&&r.state==='succeeded') selected=r; }); }
          if(selected){ local=stats.get(selected.localCandidateId); remote=stats.get(selected.remoteCandidateId);
            if(local&&remote){
              const line=`Ruta: local=${local.candidateType}/${local.protocol}@${local.address||local.ip}:${local.port} ‚áÑ remoto=${remote.candidateType}/${remote.protocol}@${remote.address||remote.ip}:${remote.port}`;
              if(wireDiagnostics._last!==line){ wireDiagnostics._last=line; log(line); }
            }
          }
        }catch{}
      },1000);
    }catch{}
  }

  // Transferencia
  let sendOffset=0, sending=false;
  function startSend(){
    if(!conn||conn.open!==true){ log('No hay conexi√≥n con receptor.','warn'); return; }
    if(!selectedFile){ log('Selecciona un fichero.','warn'); return; }
    const meta={type:'meta',name:selectedFile.name,size:selectedFile.size,mime:selectedFile.type||'application/octet-stream'};
    conn.send(meta); log(`Metadatos enviados: ${meta.name} (${human(meta.size)})`);
    sendOffset=0; setBar(0,selectedFile.size); setState('Enviando‚Ä¶'); window.onbeforeunload=()=> 'La transferencia no ha terminado. ¬øSalir?'; sending=true;
    const pump=async()=>{
      if(!sending) return;
      try{
        while(conn.open && sendOffset<selectedFile.size){
          if(conn.bufferSize>2*1024*1024) break;
          const end=Math.min(sendOffset+CHUNK,selectedFile.size);
          const buf=await selectedFile.slice(sendOffset,end).arrayBuffer();
          conn.send(buf); sendOffset=end; setBar(sendOffset,selectedFile.size);
        }
        if(sendOffset>=selectedFile.size){
          conn.send({type:'eof'}); setBar(selectedFile.size,selectedFile.size); setState('Finalizado (esperando confirmaci√≥n)‚Ä¶'); sending=false;
        }else{ setTimeout(pump,20); }
      }catch(e){ log('Error durante env√≠o: '+e.message,'err'); setTimeout(pump,200); }
    }; pump();
  }

  let recvMeta=null, recvBuffers=[], receivedBytes=0;
  function _handleData(d){
    if(d && d.type==='meta'){ recvMeta=d; recvBuffers=[]; receivedBytes=0; setBar(0,recvMeta.size); setState('Recibiendo‚Ä¶'); log(`Recibiendo: ${recvMeta.name} (${human(recvMeta.size)})`); return; }
    if(d && d.type==='eof'){ log('Fin de datos. Ensamblando‚Ä¶'); finalizeReceive(); return; }
    if(d instanceof ArrayBuffer){ recvBuffers.push(d); receivedBytes+=d.byteLength; setBar(receivedBytes,recvMeta?recvMeta.size:receivedBytes); }
    else if(typeof Blob!=='undefined' && d instanceof Blob){ recvBuffers.push(d); receivedBytes+=d.size; setBar(receivedBytes,recvMeta?recvMeta.size:receivedBytes); }
  }
  function handleIncomingData(d){
    if(d && d.type==='ack'){ log('Receptor confirm√≥ la recepci√≥n ‚úÖ','ok'); setState('Completado'); window.onbeforeunload=null; alert('Transferencia completada. Ya puedes cerrar esta pesta√±a.'); return; }
    _handleData(d);
  }

  function finalizeReceive(){
    try{
      if(!recvMeta){ log('No hay metadatos.'); return; }
      const blob=new Blob(recvBuffers,{type:recvMeta.mime||'application/octet-stream'});
      const url=URL.createObjectURL(blob);
      const a=$('downloadLink'); a.href=url; a.download=sanitize(recvMeta.name||'archivo.bin'); $('downloadBox').style.display='';
      setState('¬°Recibido! Descarga disponible.'); setBar(recvMeta.size,recvMeta.size); log('Recepci√≥n completada.','ok'); window.onbeforeunload=null;
      if(conn&&conn.open) conn.send({type:'ack'});
    }catch(e){ log('Error ensamblando: '+e.message,'err'); setState('Error en ensamblado'); }
    finally{ recvBuffers=[]; }
  }

  const sanitize=n=>String(n||'archivo.bin').replace(/[^\w\-. ]+/g,'_').slice(0,180);

  // Inputs
  $('btnInit').addEventListener('click', initPeer);
  $('fileInput').addEventListener('change', e=>{ selectedFile=e.target.files&&e.target.files[0]?e.target.files[0]:null; refreshShareEnabled(); });
  $('btnShare').addEventListener('click', createShareUrl);
  $('btnCopy').addEventListener('click', ()=>{ $('shareUrl').select(); document.execCommand('copy'); log('URL copiada.'); });

  // Rol por URL
  const url=new URL(location.href); const fromId=url.searchParams.get('from');
  $('role').innerText = fromId ? 'Receptor' : 'Emisor (por defecto)';
  // Hidratar se√±alizaci√≥n de URL
  (function hydrate(){ const p=new URL(location.href).searchParams;
    if(p.get('host')) $('host').value=p.get('host'); if(p.get('secure')) $('secure').value=p.get('secure');
    if(p.get('port')) $('port').value=p.get('port'); if(p.get('path')) $('path').value=p.get('path');
  })();

  // UX: bloquear Enter que recarga
  document.addEventListener('keydown', e=>{ if(e.key==='Enter' && ['INPUT','SELECT'].includes(e.target.tagName)) e.preventDefault(); });

  // Auto-init (y refresco de bot√≥n) ‚Äî corrige ‚Äúno hace nada‚Äù
  initPeer(); // iniciar ya
  const enabler=setInterval(refreshShareEnabled, 200);
})();
</script>
</body>
</html>
